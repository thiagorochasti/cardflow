<p>Converta seus arquivos CSV para o padr√£o Sankhya.</p>

<div id="alertBox" class="alert" style="display: none;"></div>

<form id="uploadForm">
    <label for="fileInput" class="upload-box" id="dropZone">
        <div id="dropZoneText">Clique ou arraste seu CSV aqui</div>
        <div id="fileName" class="file-name"></div>
    </label>
    <input type="file" name="file" id="fileInput" accept=".csv" required>

    <div class="progress-container" id="progressContainer">
        <div class="progress-bar-bg">
            <div class="progress-bar-fill" id="progressBar"></div>
        </div>
        <div class="status-text" id="statusText">Processando...</div>
    </div>

    <button type="submit" class="btn" id="generateBtn" disabled>Gerar Arquivo</button>
</form>

<div class="success-actions" id="successActions">
    <p style="margin-bottom: 15px; color: var(--success-color);">Arquivo gerado com sucesso!</p>
    <button class="btn btn-success" id="downloadBtn">Baixar Arquivo</button>
    <button class="btn" style="background-color: transparent; color: var(--text-secondary); margin-top: 10px;"
        onclick="location.reload()">Novo Arquivo</button>
</div>
</div>

<script>
    const fileInput = document.getElementById('fileInput');
    const fileNameDisplay = document.getElementById('fileName');
    const dropZoneText = document.getElementById('dropZoneText');
    const generateBtn = document.getElementById('generateBtn');
    const uploadForm = document.getElementById('uploadForm');
    const progressContainer = document.getElementById('progressContainer');
    const progressBar = document.getElementById('progressBar');
    const statusText = document.getElementById('statusText');
    const successActions = document.getElementById('successActions');
    const downloadBtn = document.getElementById('downloadBtn');
    const alertBox = document.getElementById('alertBox');
    const dropZone = document.getElementById('dropZone');

    let generatedBlob = null;

    // File Selection
    fileInput.addEventListener('change', function () {
        if (this.files && this.files.length > 0) {
            fileNameDisplay.textContent = this.files[0].name;
            dropZoneText.style.display = 'none';
            generateBtn.disabled = false;
            alertBox.style.display = 'none';
        }
    });

    // Drag and Drop Visuals
    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.style.borderColor = 'var(--primary-color)';
        dropZone.style.backgroundColor = 'rgba(0, 122, 255, 0.1)';
    });

    dropZone.addEventListener('dragleave', (e) => {
        e.preventDefault();
        dropZone.style.borderColor = 'var(--border-color)';
        dropZone.style.backgroundColor = 'rgba(0,0,0,0.02)';
    });

    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.style.borderColor = 'var(--border-color)';
        dropZone.style.backgroundColor = 'rgba(0,0,0,0.02)';

        if (e.dataTransfer.files.length > 0) {
            fileInput.files = e.dataTransfer.files;
            fileNameDisplay.textContent = e.dataTransfer.files[0].name;
            dropZoneText.style.display = 'none';
            generateBtn.disabled = false;
        }
    });

    // Form Submission
    uploadForm.addEventListener('submit', async function (e) {
        e.preventDefault();

        const formData = new FormData(this);

        // UI Updates
        generateBtn.style.display = 'none';
        dropZone.style.display = 'none';
        progressContainer.style.display = 'block';

        // Simulate Progress (2 seconds)
        let progress = 0;
        const interval = setInterval(() => {
            progress += 1;
            progressBar.style.width = progress + '%';

            if (progress >= 100) {
                clearInterval(interval);
                finishUpload(formData);
            }
        }, 20); // 20ms * 100 = 2000ms = 2 seconds
    });

    async function finishUpload(formData) {
        statusText.textContent = "Finalizando...";

        try {
            const response = await fetch('/', {
                method: 'POST',
                body: formData
            });

            if (response.ok) {
                generatedBlob = await response.blob();

                // Show Success
                progressContainer.style.display = 'none';
                successActions.style.display = 'block';
            } else {
                throw new Error('Erro no servidor');
            }
        } catch (error) {
            progressContainer.style.display = 'none';
            generateBtn.style.display = 'block';
            dropZone.style.display = 'block';
            alertBox.textContent = "Erro ao processar o arquivo. Tente novamente.";
            alertBox.style.display = 'block';
        }
    }

    // Download Action
    downloadBtn.addEventListener('click', () => {
        if (generatedBlob) {
            const url = window.URL.createObjectURL(generatedBlob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = 'retorno_cartao.txt';
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
        }
    });
</script>

</body>

</html>